<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Podcast hochladen – Admin</title>
  <link rel="stylesheet" href="/css/variables.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="admin.css">
  <style>
    .upload-form { max-width: 600px; padding: 2rem; }
    .upload-form label { display: block; margin-top: 1rem; color: var(--color-text); }
    .upload-form input, .upload-form textarea { width: 100%; padding: 0.6rem; margin-top: 0.25rem; border: 1px solid var(--color-border); border-radius: 8px; color: var(--color-text); }
    .upload-form textarea { min-height: 100px; }
    .upload-form button { margin-top: 1rem; padding: 0.7rem 1.25rem; background: var(--color-primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
    .upload-form button:hover { background: var(--color-primary-hover); }
    .step { display: none; }
    .step.active { display: block; }
    .upload-form .hint { display: block; font-size: 0.85rem; color: var(--color-text-secondary); margin-top: 0.25rem; }
    .current-artwork img { max-width: 160px; max-height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid var(--color-border); }
  </style>
</head>
<body class="admin-page">
  <header class="site-header">
    <div class="site-header-bg">
      <img src="/images/header-bg.jpg" alt="BBS II Wolfsburg – Schulgebäude" width="2048" height="1363" loading="eager" decoding="async" class="site-header-img">
    </div>
    <div class="site-header-overlay">
      <a href="/" class="site-logo">
        <img src="/images/logo_bbs2wob.png" alt="BBS II Wolfsburg">
        <span>Berufsbildende Schulen</span>
      </a>
      <nav class="site-nav">
        <span id="user-email" class="admin-user"></span>
        <a href="#" id="logout" style="color: rgba(255,255,255,0.95);">Abmelden</a>
      </nav>
    </div>
  </header>

  <div class="admin-layout">
    <aside class="admin-sidebar">
      <nav>
        <ul class="admin-sidebar-nav">
          <li class="nav-section">Admin</li>
          <li><a href="/admin/">Dashboard</a></li>
          <li><a href="upload.html" class="active">Neuen Podcast hochladen</a></li>
          <li><a href="db-log.html">Live DB-Log</a></li>
          <li class="nav-section">Allgemein</li>
          <li><a href="/">Zur Startseite</a></li>
        </ul>
      </nav>
    </aside>
    <main class="admin-main">
    <div class="upload-form">
      <h1>Podcast hochladen</h1>
      <p>Schritt 1: Audio-Datei hochladen → Schritt 2: Metadaten bearbeiten → Schritt 3: Veröffentlichen</p>

      <form id="upload-form">
        <div class="step active" id="step1">
          <h2>Schritt 1: Audio-Datei</h2>
          <label>Datei (mp3 oder m4a, max. 200 MB)</label>
          <input type="file" name="audio" accept=".mp3,.m4a,audio/mpeg,audio/x-m4a" required>
        </div>

        <div class="step" id="step2">
          <h2>Schritt 2: Metadaten</h2>
          <label>Name der Episode (wird überall angezeigt, nicht der Dateiname) *</label>
          <input type="text" name="title" required placeholder="z.B. Einführung oder Folge 1 – Thema">
          <label>Beschreibung</label>
          <textarea name="description" placeholder="Kurzbeschreibung der Episode"></textarea>
          <label>Welche Reihe / Playlist</label>
          <input type="text" name="series" id="series" list="series-list" placeholder="z.B. Umwelt, Politik, …">
          <datalist id="series-list"></datalist>
          <label>Welche Klasse hat gemacht (optional)</label>
          <input type="text" name="class_info" placeholder="z.B. BG21, FOS22">
          <label>Cover-Bild (optional)</label>
          <div id="current-artwork" class="current-artwork" style="display:none; margin-bottom: 0.5rem;"></div>
          <input type="file" name="artwork" accept=".jpg,.jpeg,.png,.webp,image/jpeg,image/png,image/webp">
          <span class="hint">JPG, PNG oder WebP, max. 5 MB. Wird als Vorschaubild der Episode angezeigt.</span>
          <label>Dauer (Sekunden, optional)</label>
          <input type="number" name="duration_seconds" placeholder="z.B. 600 für 10 Min">
        </div>

        <button type="button" id="btn-next">Weiter</button>
        <button type="submit" id="btn-publish" style="display:none;">Veröffentlichen</button>
      </form>

      <p id="status" style="margin-top:1rem; color: var(--color-text);"></p>
    </div>
    </main>
  </div>

  <script>
    const API = '/api';
    const tokenKey = 'podcast_token';
    let step = 1;
    let selectedFile = null;

    function getToken() { return localStorage.getItem(tokenKey); }
    function clearToken() { localStorage.removeItem(tokenKey); }
    function escapeHtml(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    if (!getToken()) { window.location = '/admin/'; }

    function handleAuthError(res, statusEl) {
      if (res.status === 401) {
        clearToken();
        if (statusEl) statusEl.textContent = 'Session abgelaufen. Leite zur Anmeldung weiter...';
        setTimeout(() => { window.location = '/admin/?expired=1'; }, 1500);
        return true;
      }
      return false;
    }

    const form = document.getElementById('upload-form');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const btnNext = document.getElementById('btn-next');
    const btnPublish = document.getElementById('btn-publish');

    const urlParams = new URLSearchParams(location.search);
    const editId = urlParams.get('id');
    async function fillSeriesDatalist() {
      try {
        const r = await fetch(API + '/episodes/meta/series');
        const data = await r.json();
        const list = document.getElementById('series-list');
        list.innerHTML = (data.series || []).map(s => '<option value="' + escapeHtml(s) + '">').join('');
      } catch (_) {}
    }
    fillSeriesDatalist();

    if (editId) {
      document.querySelector('h1').textContent = 'Episoden bearbeiten';
      step1.classList.remove('active');
      step2.classList.add('active');
      btnNext.style.display = 'none';
      btnPublish.style.display = 'inline-block';
      btnPublish.textContent = 'Speichern';
      fetch(API + '/episodes/' + editId).then(r => r.json()).then(ep => {
        form.elements.title.value = ep.title;
        form.elements.description.value = ep.description || '';
        form.elements.series.value = ep.series || '';
        form.elements.class_info.value = ep.classInfo || '';
        form.elements.duration_seconds.value = ep.durationSeconds || '';
        const artEl = document.getElementById('current-artwork');
        if (ep.artworkUrl && artEl) {
          artEl.style.display = 'block';
          artEl.innerHTML = '<span class="hint">Aktuelles Cover:</span><br><img src="' + escapeHtml(ep.artworkUrl) + '" alt="">';
        }
      });
    }

    btnNext.onclick = () => {
      const fileInput = form.audio;
      if (!fileInput.files.length) { alert('Bitte wähle eine Audio-Datei.'); return; }
      selectedFile = fileInput.files[0];
      // Do not pre-fill title from filename – user should enter display name (e.g. "Einführung") so it shows correctly everywhere
      step1.classList.remove('active');
      step2.classList.add('active');
      btnNext.style.display = 'none';
      btnPublish.style.display = 'inline-block';
    };

    form.onsubmit = async (e) => {
      e.preventDefault();
      const status = document.getElementById('status');
      status.textContent = 'Wird hochgeladen...';

      if (editId) {
        const artworkInput = form.elements.artwork;
        if (artworkInput && artworkInput.files && artworkInput.files[0]) {
          const fdArt = new FormData();
          fdArt.append('artwork', artworkInput.files[0]);
          const resArt = await fetch(API + '/episodes/' + editId + '/artwork', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + getToken() },
            body: fdArt
          });
          if (handleAuthError(resArt, status)) return;
          if (!resArt.ok) {
            status.textContent = 'Fehler Cover: ' + ((await resArt.json()).error || resArt.statusText);
            return;
          }
        }
        const res = await fetch(API + '/episodes/' + editId, {
          method: 'PATCH',
          headers: { 'Authorization': 'Bearer ' + getToken(), 'Content-Type': 'application/json' },
          body: JSON.stringify({
            title: form.elements.title.value,
            description: form.elements.description.value,
            series: form.elements.series.value.trim() || undefined,
            class_info: form.elements.class_info.value.trim() || undefined,
            duration_seconds: form.elements.duration_seconds.value ? parseInt(form.elements.duration_seconds.value) : undefined
          })
        });
        if (handleAuthError(res, status)) return;
        if (res.ok) {
          status.textContent = 'Gespeichert.';
          setTimeout(() => location.href = '/admin/', 1500);
        } else {
          status.textContent = 'Fehler: ' + ((await res.json()).error || res.statusText);
        }
        return;
      }

      const fd = new FormData();
      fd.append('audio', selectedFile);
      const artworkInput = form.elements.artwork;
      if (artworkInput && artworkInput.files && artworkInput.files[0]) {
        fd.append('artwork', artworkInput.files[0]);
      }
      fd.append('title', form.elements.title.value);
      fd.append('description', form.elements.description.value);
      if (form.elements.series.value.trim()) fd.append('series', form.elements.series.value.trim());
      if (form.elements.class_info.value.trim()) fd.append('class_info', form.elements.class_info.value.trim());
      if (form.elements.duration_seconds.value) fd.append('duration_seconds', form.elements.duration_seconds.value);

      const res = await fetch(API + '/episodes', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + getToken() },
        body: fd
      });

      if (handleAuthError(res, status)) return;
      if (res.ok) {
        status.textContent = 'Hochgeladen! Der Podcast erscheint jetzt auf der Website.';
        setTimeout(() => location.href = '/admin/', 2000);
      } else {
        const err = await res.json();
        status.textContent = 'Fehler: ' + (err.error || res.statusText);
      }
    };
  </script>
</body>
</html>
